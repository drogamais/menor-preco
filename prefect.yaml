name: mp-feeder-project
prefect-version: 3.6.1

pull:
- prefect.deployments.steps.git_clone:
    repository: https://github.com/drogamais/menor-preco.git
    branch: prefect_test

# Este bloco roda DEPOIS do 'pull' e ANTES do 'runtime'
build:
  # Comando 1: Cria um venv chamado 'venv' dentro da pasta clonada
  - prefect.deployments.steps.run_shell_script:
      script: "python -m venv .venv"

  # Comando 2: Ativa o venv rec√©m-criado e instala as libs
  - prefect.deployments.steps.run_shell_script:
      script: ".venv\\Scripts\\activate && python -m pip install --upgrade pip wheel && pip install -r requirements.txt"

deployments:
- name: mp-feeder-etl-diario
  version: null
  tags:
  - etl
  - producao
  description: Roda o ETL do Menor Preco (1 lote por execucao)
  schedule:
    cron: "0 5 * * *"
    timezone: "America/Sao_Paulo"
  entrypoint: mp_feeder_flow.py:mp_feeder_flow
  work_pool:
    name: etl-agent-pool
  
  runtime:
    type: subprocess
    config:
      # Agora este caminho funciona, porque o 'build' acabou de criar
      python: "./.venv/Scripts/python.exe"
      env:
        PYTHONUTF8: "1"
